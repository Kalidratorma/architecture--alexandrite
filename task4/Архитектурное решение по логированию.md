# Архитектурное решение по логированию

## 1. Анализ системы и определение логов

Системы, из которых необходимо собирать логи:

- Онлайн-магазин
- CRM
- MES
- Очередь сообщений (RabbitMQ)

### Уровень INFO — обязательные события:
- Создание нового заказа
- Изменение статуса заказа (время, заказ, пользователь)
- Успешная отправка сообщения в очередь
- Получение сообщения из очереди
- Выполнение расчёта стоимости заказа (MES)
- Успешная авторизация пользователя

### Уровень WARN:
- Неуспешная попытка расчёта стоимости (например, превышено время)
- Сообщение не может быть обработано
- Проблемы при валидации пользовательских данных

### Уровень ERROR:
- Ошибки базы данных
- Ошибки бизнес-логики
- Потеря связи с RabbitMQ
- Исключения в процессе обработки заказа

## 2. Мотивация

Внедрение централизованного логирования позволит:

- Быстрее диагностировать причины проблем
- Сократить время отклика команды поддержки
- Собирать статистику по техническим сбоям
- Повысить надёжность и стабильность системы

### Влияние на метрики:
- Среднее время решения инцидентов
- Количество ошибок по категориям
- Количество запросов от клиентов по неполадкам
- Общее качество SLA
- Количество неуспешных операций

## 3. Предлагаемое решение

### Технологии:
- **Filebeat** — сбор логов
- **Logstash** — предварительная обработка и обогащение
- **Elasticsearch** — хранение логов
- **Kibana** — визуализация и поиск

Логи будут поступать с каждого приложения через Filebeat в Logstash, который передаёт их в Elasticsearch. Kibana используется для визуализации.

### Безопасность:
- Доступ к логам только через Kibana с SSO
- Ограничение по ролям: только DevOps и поддержка
- Удаление персональных данных или маскирование (PII)

### Политика хранения:
- Хранение логов 30 дней
- Отдельный индекс под каждый сервис
- Максимальный размер индекса — 10ГБ

## 4. Анализ логов

Планируется внедрить:

- **Алертинг** по ключевым ошибкам (например, более 5 ошибок 500 в минуту)
- **Поиск аномалий** — например, если резко возросло количество заказов или ошибок

## 5. Критерии выбора технологии

| Критерий               | ELK Stack             | OpenSearch           | Splunk             |
|------------------------|-----------------------|----------------------|--------------------|
| Лицензия               | Elastic License       | Apache 2.0           | Проприетарная      |
| Расходы                | Бесплатно (самостоятельно) | Бесплатно        | Дорого             |
| Масштабируемость       | Средняя               | Высокая              | Очень высокая      |
| Удобство визуализации  | Хорошее               | Хорошее              | Отличное           |
| Сообщество и поддержка | Большое               | Активное             | Ограничено, платно |

**Выбор:** ELK Stack — оптимальный выбор по балансу между функциональностью, стоимостью и зрелостью экосистемы.

![Схема с логированием](./diagram_logging.drawio)
