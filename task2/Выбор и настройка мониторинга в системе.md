
# Выбор и настройка мониторинга в системе

## 1. Анализ текущей ситуации
В настоящий момент используется только Яндекс Метрика, которая не покрывает внутренние процессы и API.

Необходимо внедрить мониторинг внутренних сервисов и API, чтобы оперативно обнаруживать проблемы производительности и стабильности.

## 2. Мотивация
Добавление системы мониторинга позволит:

- Уменьшить время простоя сервисов и API, оперативно реагируя на аномалии.
- Улучшить удовлетворённость клиентов за счёт своевременной обработки проблем.
- Сократить затраты на поддержку благодаря быстрому обнаружению и решению проблем.

### Технические и бизнес-метрики, на которые повлияет внедрение мониторинга:

- **Среднее время простоя сервиса**
- **Время отклика MES и CRM**
- **Количество успешно завершённых заказов**
- **Количество заказов, выполненных в обещанные сроки**
- **Количество обращений в техподдержку по причине нестабильной работы**

## 3. Выбор подхода к мониторингу
Для мониторинга будут использоваться подходы:

- **USE (Utilization, Saturation, Errors)** — для мониторинга состояния инфраструктуры (CPU, память, диски).
- **RED (Rate, Errors, Duration)** — для мониторинга API и сервисов.

Причина выбора:  
Подходы USE и RED идеально дополняют друг друга, обеспечивая полную картину работоспособности системы.

## 4. Выбранные метрики и компоненты мониторинга

| Метрика                  | Причина отслеживания                              | Компонент         | Ярлыки (labels)     |
|--------------------------|---------------------------------------------------|-------------------|---------------------|
| CPU, RAM, Disk Utilization | Предотвращение перегрузки инфраструктуры        | Prometheus        | сервис, инстанс     |
| API Latency (MES, CRM)     | Снижение времени ожидания для клиента           | Prometheus        | метод API, статус   |
| API Error Rate             | Контроль качества и стабильности API            | Prometheus        | метод API, статус   |
| Количество запросов API    | Анализ нагрузки и планирование ресурсов         | Prometheus        | сервис, метод API   |
| Время ответа базы данных   | Выявление узких мест в работе базы данных       | Prometheus        | запрос, база данных |

## 5. План действий (Техническое задание)
- Поднять Prometheus в инфраструктуре.
- Настроить экспортеры Prometheus на всех инстансах.
- Настроить сбор метрик API через middleware или sidecar-приложения.
- Создать дашборды Grafana для мониторинга:
  - CPU, RAM, Disk по инстансам.
  - API Latency и Error Rate для MES и CRM.
  - Время ответа базы данных.
- Настроить алерты в Prometheus Alertmanager.

## 6. Дополнительное задание (Показатели насыщенности и реакции на них)

### Показатели насыщенности:
- CPU выше 80% в течение 5 минут.
- Память выше 90% в течение 5 минут.
- Время ответа API выше 2 секунд.

### Действия при превышении показателей:
- Создание автоматического тикета в системе управления задачами.
- Оповещение в Slack-команду поддержки.
- Автоматическое масштабирование сервисов в случае стабильного превышения пороговых значений.

## Мониторинг RabbitMQ

Для мониторинга брокера сообщений RabbitMQ может быть использован **RabbitMQ Exporter** в связке с Prometheus.
Экспортер использует стандартный management plugin RabbitMQ и позволяет получать следующие метрики:

- количество сообщений в очередях
- число потребителей
- соединения и каналы
- скорость публикации и доставки сообщений
- время отклика брокера

В боевом окружении такой подход позволит отслеживать состояние очередей и своевременно реагировать на аномалии.
